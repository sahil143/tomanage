# Expo AuthSession Setup for TickTick OAuth

## Why Use Expo AuthSession?

Since TickTick doesn't accept custom URL schemes (`tomanage://`), we're using **Expo AuthSession** which:
- ‚úÖ Generates redirect URIs that OAuth providers accept
- ‚úÖ Works in both development (Expo Go) and production (standalone builds)
- ‚úÖ Handles all OAuth edge cases automatically
- ‚úÖ No backend server required

## Quick Setup

### Step 1: Get Your Redirect URI

1. **Run your app** (or just check the console when component loads)
2. **Look for this log:**
   ```
   üìç Expo AuthSession Redirect URI: https://auth.expo.io/@your-username/tomanage
   ```
   OR (in standalone builds):
   ```
   üìç Expo AuthSession Redirect URI: tomanage://
   ```

3. **Copy that exact URL**

### Step 2: Register Redirect URI in TickTick

1. Go to [TickTick Developer Console](https://developer.ticktick.com/)
2. Open your OAuth application
3. Find "Redirect URI" field
4. **Add the redirect URI** you copied from the console
5. Save changes

### Step 3: Update Your Settings Screen

Replace the old auth button with the new Expo one:

```typescript
// In src/screens/SettingsScreen.tsx

// Change this import:
import { TickTickAuthButton } from '../components/TickTickAuthButton';

// To this:
import { TickTickAuthButtonExpo } from '../components/TickTickAuthButtonExpo';

// And use it:
<TickTickAuthButtonExpo
  onAuthSuccess={() => {
    console.log('TickTick connected successfully');
  }}
  onAuthError={(error) => {
    console.error('TickTick auth error:', error);
  }}
/>
```

### Step 4: Test the Flow

1. Open your app
2. Navigate to Settings
3. Tap "Connect TickTick"
4. Authorize in browser
5. You'll be redirected back to the app
6. Should see "Connected" status

## Understanding Redirect URIs

### In Development (Expo Go):

**Redirect URI format:**
```
https://auth.expo.io/@your-username/tomanage
```

This is an Expo proxy that:
1. Receives the OAuth callback from TickTick
2. Redirects back to your Expo Go app
3. Works on any device running Expo Go

### In Production (Standalone Build):

**Redirect URI format:**
```
tomanage://
```

This is your custom scheme that:
1. Opens directly in your installed app
2. No proxy needed
3. More secure and faster

### Both Work Automatically! üéâ

Expo AuthSession handles both cases automatically. You just need to register the appropriate redirect URI for your environment.

## Multiple Redirect URIs

You can register **both** redirect URIs in TickTick:

1. `https://auth.expo.io/@your-username/tomanage` (for development)
2. `tomanage://` (for production builds)

This way, OAuth works in both environments.

## Code Changes Summary

### What Was Changed:

1. **Installed packages:**
   ```bash
   yarn add expo-auth-session expo-crypto
   ```

2. **Created new component:**
   - [src/components/TickTickAuthButtonExpo.tsx](src/components/TickTickAuthButtonExpo.tsx)
   - Uses `expo-auth-session` instead of manual OAuth
   - Automatically generates correct redirect URIs

3. **Key differences from old implementation:**

   | Feature | Old (Manual) | New (Expo AuthSession) |
   |---------|--------------|------------------------|
   | Redirect URI | `tomanage://oauth/ticktick` | Auto-generated by Expo |
   | State management | Manual | Handled by Expo |
   | PKCE support | Manual | Built-in |
   | Works with TickTick | ‚ùå No | ‚úÖ Yes |
   | Dev/Prod handling | Manual | Automatic |

## Testing Checklist

- [ ] Run app and check console for redirect URI
- [ ] Copy the redirect URI shown in console
- [ ] Register it in TickTick developer console
- [ ] Update SettingsScreen to use new component
- [ ] Restart app
- [ ] Tap "Connect TickTick"
- [ ] Authorize in browser
- [ ] Should redirect back to app
- [ ] Should show "Connected" status

## Troubleshooting

### Issue: "Invalid redirect_uri"

**Solution:** Make sure you registered the EXACT redirect URI from the console logs:
```
üìç Expo AuthSession Redirect URI: <copy this exact URL>
```

### Issue: Can't see the redirect URI in console

**Solution:** The component shows it automatically. If you don't see it:
1. Make sure you're using `TickTickAuthButtonExpo`
2. Check you've imported it correctly
3. Look for logs starting with üìç

### Issue: Works in Expo Go but not in production

**Solution:** Register both redirect URIs:
- Development: `https://auth.expo.io/@your-username/tomanage`
- Production: `tomanage://`

### Issue: "OAuth request not ready"

**Solution:**
1. Make sure Client ID is in .env file
2. Restart the app after changing .env
3. Check that expo-auth-session is installed

## Migration Guide

If you want to switch to this new implementation:

### Option 1: Replace Existing Component

```bash
# Backup old component
mv src/components/TickTickAuthButton.tsx src/components/TickTickAuthButton.tsx.old

# Rename new component
mv src/components/TickTickAuthButtonExpo.tsx src/components/TickTickAuthButton.tsx
```

Then remove the "Expo" suffix in the component:
```typescript
// Change from:
export function TickTickAuthButtonExpo

// To:
export function TickTickAuthButton
```

### Option 2: Use Both (Recommended for Testing)

Keep both components and switch between them in SettingsScreen:

```typescript
// Test with Expo version:
import { TickTickAuthButtonExpo as TickTickAuthButton } from '../components/TickTickAuthButtonExpo';

// Or use old version:
// import { TickTickAuthButton } from '../components/TickTickAuthButton';
```

## What to Delete (Optional)

Once the Expo AuthSession version works, you can optionally delete:

- [src/components/TickTickAuthButton.tsx](src/components/TickTickAuthButton.tsx) - Old manual implementation
- Parts of [src/utils/deepLinking.ts](src/utils/deepLinking.ts) - OAuth-specific code (keep the deep link parsing)

But I recommend keeping them as backup until you're fully confident the new version works.

## Expo AuthSession Benefits

1. **Just Works‚Ñ¢** - No fighting with redirect URI formats
2. **Development Friendly** - Works great with Expo Go
3. **Production Ready** - Switches to custom scheme automatically
4. **Well Maintained** - Official Expo package
5. **Secure** - Handles state, PKCE, and other security automatically
6. **Cross-Platform** - Same code works on iOS and Android

## Next Steps

1. ‚úÖ Get redirect URI from console
2. ‚úÖ Register it in TickTick
3. ‚úÖ Update SettingsScreen to use new component
4. ‚úÖ Test the flow
5. ‚úÖ Celebrate when it works! üéâ

## Questions?

Check these docs:
- [Expo AuthSession Docs](https://docs.expo.dev/versions/latest/sdk/auth-session/)
- [OAuth 2.0 Guide](https://oauth.net/2/)
- [TickTick API Docs](https://developer.ticktick.com/)
